# 4. Работа с Данными: Коннекторы

Коннекторы — это декларативный слой доступа к данным в Serverokey. Они позволяют абстрагироваться от конкретного способа хранения (в памяти, в файле, в базе данных) и работать с данными в едином, предсказуемом формате. Вся настройка производится в секции `connectors` файла `manifest.js`.

## Основная Концепция

Вы объявляете именованный источник данных (например, `receipt` или `positions`) и указываете его тип. Вся дальнейшая работа с этим источником данных в `steps` и шаблонах будет происходить через его имя, независимо от того, где физически хранятся данные.

```javascript
// manifest.js
connectors: {
  // Имя коннектора: 'receipt'
  receipt: {
    type: 'wise-json',
    collection: 'receipt-storage',
    initialState: { /* ... */ }
  },

  // Имя коннектора: 'viewState'
  viewState: {
    type: 'in-memory',
    initialState: { query: '' }
  }
}
```

## Единый Формат Данных для Коллекций

Ключевая особенность коннекторов в Serverokey — унифицированная структура данных для коллекций (списков объектов). Любой коннектор, хранящий коллекцию (товары, пользователи, посты и т.д.), представляет данные в виде объекта следующей структуры:

```javascript
{
  // `items` — это зарезервированное имя для массива с элементами коллекции.
  "items": [
    { "id": 1, "name": "Товар 1", "price": 100 },
    { "id": 2, "name": "Товар 2", "price": 200 }
  ],

  // Любые другие поля являются "мета-данными" коллекции.
  "total": 300,
  "lastUpdate": "2024-07-15T10:00:00Z"
}
```
Такой подход обеспечивает предсказуемость. Вы всегда знаете, что для доступа к списку элементов нужно обращаться к свойству `.items`.

### Доступ к данным
Внутри `steps` и шаблонов все данные, прочитанные из коннекторов, помещаются в глобальный объект `data`.

*   Доступ к коннектору `receipt`: `data.receipt`
*   Доступ к массиву товаров из коннектора `positions`: `data.positions.items`
*   Доступ к мета-полю `total` из коннектора `receipt`: `data.receipt.total`

## Типы Коннекторов

### 1. `wise-json` (Рекомендуемый)

Это основной, самый мощный и производительный тип коннектора. Он использует `wise-json-db` для хранения данных в оптимизированных файлах на диске, обеспечивая персистентность (сохранность данных между перезапусками сервера).

*   **Назначение:** Для всех критически важных данных: пользователи, сессии, товары, заказы, чеки.
*   **Настройки:**
    *   `type: 'wise-json'`
    *   `collection`: (Обязательно) Уникальное имя коллекции в базе данных. Будет соответствовать имени папки в `wise-db-data`.
    *   `initialState`: (Опционально, но рекомендуется) Объект с начальным состоянием, который будет создан, если база данных пуста.
    *   `migrations`: (Опционально) Массив правил для автоматического обновления структуры существующих данных.
    *   `computed`: (Опционально) Массив правил для вычисляемых полей.

### 2. `in-memory`

Хранит данные исключительно в оперативной памяти (RAM) сервера.

*   **Назначение:** Для временных, некритичных данных, связанных с сеансом одного пользователя или состоянием интерфейса. Например, текст в поле поиска, состояние открытых/закрытых вкладок, фильтры.
*   **Ключевая особенность:** Все данные **полностью теряются** при перезапуске сервера.
*   **Настройки:**
    *   `type: 'in-memory'`
    *   `initialState`: (Настоятельно рекомендуется) Начальное состояние данных при старте сервера.

### 3. `json` (Устаревший, для совместимости)

Хранит данные в простом, человекочитаемом JSON-файле в директории `app/data/`.

*   **Назначение:** Для простых конфигурационных данных или прототипирования. Менее производителен и надежен по сравнению с `wise-json` при частых операциях записи.
*   **Настройки:**
    *   `type: 'json'`
    *   `initialState`: Начальное состояние, которое будет записано в файл, если он не существует.

## Продвинутые Возможности (`wise-json` и `json`)

### Вычисляемые поля (`computed`)

Эта секция позволяет декларативно вычислять значения одних полей на основе других. (Эта функциональность на данный момент устарела в пользу `action:run`, но поддерживается для обратной совместимости).

```javascript
receipt: {
  // ...
  computed: [
    // Форматирует поле 'total' до двух знаков после запятой
    { "target": "total", "format": "toFixed(2)" }
  ]
}
```

### Миграции Данных (`migrations`)

Это мощный инструмент для безопасного изменения структуры данных без ручного редактирования базы. Он доступен для `wise-json`.

**Сценарий:** Вы решили добавить поле `createdAt` ко всем товарам в чеке.

```javascript
// manifest.js
receipt: {
  type: 'wise-json',
  collection: 'receipt',
  initialState: { items: [], createdAt: null }, // Добавляем новое поле в модель
  migrations: [
    {
      // Правило №1: Если у элемента в `items` нет поля `createdAt`...
      "if_not_exists": "createdAt",
      // ...то установить ему значение по умолчанию.
      "set": { "createdAt": "new Date().toISOString()" }
    }
  ]
}
```
При первом чтении данных из коннектора `receipt` после этого изменения, движок автоматически пройдет по всем `items`, добавит недостающее поле `createdAt` и сохранит обновленные данные обратно в базу. Это гарантирует консистентность данных при эволюции вашего приложения.